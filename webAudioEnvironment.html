<!doctype html>

<html>
	<head>
		<link href='https://fonts.googleapis.com/css?family=Roboto+Condensed:400,700,300,700italic,400italic,300italic' rel='stylesheet' type='text/css'   >
		<script src='jquery.js'></script>

		<script src='jquery-ui.js'></script>
		<link rel='stylesheet' type='text/css' href='webAudioEnvironment.css'>
		<link rel='stylesheet' type='text/css' href='jquery-ui.css'>


	</head>
	<body>
		<h6>web audio signal processor</h6>
		<input
			type='button'
			class='create-node-button'
			data-nodetype='osc'
			value='Create Oscillator Node'
		>
		<input
			type='button'
			class='create-node-button'
			data-nodetype='gain'
			value='Create Gain Node'
		>
		<div id='app-window'>
		</div>
	</body>
	<script>
//dont do shit til we load
$(function() {
//create an audio context
	var audioContext = new (
		window.AudioContext ||
		window.webkitAudioContext
	)();

	var nodeArray = new Array;


	SVG = {
		createCanvas : function( width, height, container, pos, z){
			var canvas = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
			canvas.setAttribute('width', width);
			canvas.setAttribute('height', height);
			//canvas.setAttribute('position', 'absolute');

			canvas.setAttribute('pointer-events', 'none');
			
			var htmlstring = '<div style=" position: ' + pos + ' ", top: 0px, left: 0px, height: 0, z-index: ' + z + '></div>';
			console.log (htmlstring);
			var svgContain = $( htmlstring );
			container.append(svgContain);
			svgContain.append( canvas );    
			return canvas;
		},
		  createLine : function (x1, y1, x2, y2, color, w) {
			var line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
			line.setAttribute('x1', x1);
			line.setAttribute('y1', y1);
			line.setAttribute('x2', x2);
			line.setAttribute('y2', y2);
			line.setAttribute('stroke', color);
			line.setAttribute('stroke-width', w);
			return line;
		  },
		updateLine: function (which, x1, y1, x2, y2) {
			which.setAttribute('x1', x1);
			which.setAttribute('y1', y1);
			which.setAttribute('x2', x2);
			which.setAttribute('y2', y2);
		},
		deleteLine: function (which) {
			which.remove();
		}
	}

	var LineContext = function( pos, z) {
		this.canvas = SVG.createCanvas (
			$( '#app-window' ).width(),
			$( '#app-window' ).height(),
			$( '#app-window' ),
			pos,
			z
		);
		//console.log (this.canvas);
	}
	var foregroundLines = new LineContext('absolute', '1000');
	var backgroundLines = new LineContext('absolute', '10');
	

	//backgroundLines.canvas.css( top, 0);

	//creates relevant button for each node type
	$(' .create-node-button ').click ( function() {
		createNode (
			$( this ).data().nodetype	
		);
	});
	
	function updateConnectingLine (origin, end, line) {
		var y1 = origin.offset().top + origin.height()/2;
		var x1 = origin.offset().left + origin.width()/2;
		var y2 = end.offset().top + end.width()/2;
		var x2 = end.offset().left + end.width()/2;
		var appwindow = $( '#app-window' );
	    var offy = appwindow.offset().top;
		var offx = appwindow.offset().left;	

		SVG.updateLine( line, x1-offx, y1-offy, x2-offx, y2-offy);
	}



	var GainNode = function() {
		this.gain = audioContext.createGain();

		//create control window
		this.controls = $("<div class='node-controls'></div>");
		$( '#app-window' ).append(this.controls);
		//we store the object in the window...
		this.controls.data('rootObj', this);

		NodeOp.createDragHandle(this.controls,'Gain');

		var currentrow = NodeOp.createRow(this.controls, 'io'); //new row i/o
		var ioDisplay = $("<h1>I/O</h1>");
		currentrow.append(ioDisplay);
		var currentrow = NodeOp.createRow(this.controls, 'gain'); //new row gain io
		//ROW CONTROLS

		//create gain numerical input
		currentrow.numberInput = $("<input type='number' value='.5' step='.1'>");
		currentrow.append(currentrow.numberInput);

		//we use parent() to get to object reference stored in its data and call a method
		//and we have to wrap the call in an anonymous function so we can do some maths...
		currentrow.numberInput.on ('keyup mouseup', function() {
			$( this ).parents( '.node-controls' ).data( 'rootObj' ).updateGain( 'gain', this.value );
		});

		//END ROW CONTROLS


		currentrow = NodeOp.createRow(this.controls, 'data'); //new row 
		//simply displays current volume (as percent)
		this.controls.gainDisplay = $( "<p>" + this.gain.gain.value * 100 + "%</p>" );
		currentrow.append (this.controls.gainDisplay);
	}

	GainNode.prototype.updateGain = function(type, value) {
		this.gain.gain.value = value;
		this.controls.gainDisplay.html( (this.gain.gain.value * 100).toFixed(2) );
		//console.log (this.gain.gain);
	}

	NodeOp = {
		//initializes output handle draggability does NOT create handle
		initOutputHandle : function(handle) {
			handle.draggable({
			revertDuration: 200,
			revert: function() {
				console.log ( 'revert ' + handle );
				$(handle).removeClass('selected');

					//passing values to active line
				handle.updateLine = setInterval(function() {
					var notch = handle.siblings( '.output-notch' ) [0];

					updateConnectingLine (handle, $(notch) ,foregroundLines.canvas.aline);
					console.log ( 'wheeee' );
				}, 1);
				console.log ('true');
				return('true');
			},
				drag: function() {
						var notch = handle.siblings( '.output-notch' ) [0];
						updateConnectingLine ( handle, $( notch ) ,foregroundLines.canvas.aline);
				},
				start: function() {
					$(handle).parents('.node-controls ').css('z-index', '1500'); //whole parent can we make it just output handle?
					$(handle).addClass('selected');

					//going to have to do all this svg shit differently
					var line = SVG.createLine( 0,0,0,0, $(handle).css('background-color'), 4, 'true'); //it gets updated right away anyway...

					//CURRENTLY HARDCODED AS foregroundLines WATCH OUT
					foregroundLines.canvas.aline = foregroundLines.canvas.appendChild(line);

				},
				stop: function(event, ui) {
					console.log('stop');
					$(handle).parents('.node-controls ').css('z-index', '999'); //whole parent can we make it just output handle?
					$(foregroundLines.canvas).empty();					
					clearInterval (handle.updateLine);
				}
			});
		},
		initInputHandle : function(handle) {
			handle.droppable({
				accept: '.output-handle',
				activeClass : '.selected' ,
				drop : function(event, ui) {

					var outputHandle = ui.draggable;
					//console.log(outputHandle.val);
					//var style = outputHandle.css();
					//console.log ( style);

					//our output-handle is going to a foreign land
					//we need to make sure it rememberswhere home is...
					outputHandle.val('node-controls', outputHandle.parents('.node-controls' ) ); //store control window of parent
					outputHandle.val('output-notch', outputHandle.siblings( '.output-notch' )[0] );
					console.log ('HERE1' + outputHandle.val('output-notch')[0] );

					//sloppy list of css to revert after we change parents...
					//put this in an array and get it out of here!
					bgcol = outputHandle.css ( 'background-color' );
					col = outputHandle.css ( 'color' );
					ff = outputHandle.css ( 'font-family' );
					fs = outputHandle.css ( 'font-size' );
					lh = outputHandle.css ( 'line-height' );
					fw = outputHandle.css ( 'font-weight' );
					fst = outputHandle.css ( 'font-style' );
					shadow = '-5px 0px 10px 0px ' + bgcol;

					//changing the parent to the input node we are connecting to...
					outputHandle.appendTo (this);
					outputHandle.css({ top : 9, left: 0});
					outputHandle.draggable('option','revert','false');
					outputHandle.draggable('destroy');
					outputHandle.removeClass('selected');
					//outputHandle.css( style );

					//re-render handle style there must be a better way ughughgu
					outputHandle.css( 'background-color', bgcol );
					outputHandle.css( 'color', col );	
					outputHandle.css( 'font-family', ff );
					outputHandle.css( 'font-size', fs );	
					outputHandle.css( 'line-height', lh );
					outputHandle.css( 'font-weight', fw );;
					outputHandle.css( 'font-style', fs );	

					outputHandle.css( '-webkit-box-shadow', shadow);
					
					//made it!!
					//lets draw a line to celebrate!

					//get these foreground lines out of my way
					$(foregroundLines.canvas).empty();
					//and draw some nice background lines instead
					var line = SVG.createLine( 0,0,100,100, bgcol, 1, 'true'); //it gets updated right away anyway...
					backgroundLines.canvas.appendChild(line);
					outputHandle.val( 'line', line );
					//console.log (line);

					console.log ('HERE' + outputHandle.val ( 'output-notch') );

					updateConnectingLine (outputHandle, outputHandle.val ( 'output-notch' ), line)

					//outputHandle.
					console.log('drop');
					//ui.draggable.draggable('option','revert','false');
				},
				over : function(event) {
					console.log (this);
				}
			});
		},
		//creates the top bar handle for dragging window around
		createDragHandle : function(controls, title) {
			//creates top bar to drag it by --no reference needed!
			controls.append ("<div class='drag-handle'>"+title+"</div>");
			controls.draggable({
				containment: $( '#app-window' ),
				handle: '.drag-handle',
				stack: '.node-controls',
				start: function() {
					controls.css('opacity', '0.8');
					controls.addClass('selected');
				},
				drag: function() {
				},
				stop: function() {
					controls.css('opacity', '1');
					controls.removeClass('selected');
				}
			});
		},
		createRow : function (controls, type) {
			var row = $( "<div class='row " + type + "  '> </div>");
			controls.append (row);
			var input = true;
			var output = true;
			var symbol = false;
			var cssString = 'color: magenta'

			switch(type) {
				case ('freq') :
					symbol ='&#402;';
					symbol ='&#402;';

					cssString = (
					"background: slategrey, " +
					"color: white, " +
					"padding: none, " +
					"font-family: inherit, " +
					"font-style: italic ");


					break;
				case ('gain') :
					symbol = 'A';
					symbol = 'A';

					break
				case ('data') :
					
					input = false;
					output = false;
					break;
				case ('input') :
					output = false;
					break;
				case ('output') :
					input = false;
					break;
				case ('io') :
					break;
			}
			
			if (input) {
				//leave if we don't want an io
				//makes our input handle
				if (!symbol) {symbol = '<bold>I</bold>'};

				row.inputHandle = $( "<div class ='input-handle noselect'>"+ symbol + "</div>" );
				row.append (row.inputHandle);
				row.inputHandle.css({ cssString });

				NodeOp.initInputHandle (row.inputHandle);
			}

			if (symbol == '<bold>I</bold>') {
				symbol = false;
			}

			if (output) {

				if (!symbol)  {symbol = '<bold>O</bold>'};

				//creates a notch for when we drag output away
				row.outputNotch = $( "<div class ='output-notch noselect'></div>" );
				row.append (row.outputNotch);

				//creates a handle we can drag an output out of
				row.outputHandle = $( "<div class ='output-handle noselect'>" + symbol + "</div>" );
				console.log(row.outputHandle);
				row.append(row.outputHandle);
				row.outputHandle.css({ cssString });

				//THIS could be done better!!
				NodeOp.initOutputHandle (row.outputHandle);
			}

			//so we can add controls
			return row;
		}


	};

	var OscNode = function () {

		this.osc = audioContext.createOscillator();

		//create control window
		this.controls = $("<div class='node-controls'></div>");
		$( '#app-window' ).append(this.controls);
		//we store the object in the window...
		this.controls.data('rootObj', this);

		NodeOp.createDragHandle(this.controls,'Oscillator');

		currentrow = NodeOp.createRow(this.controls, 'output'); //new row for output

		var currentrow = NodeOp.createRow(this.controls, 'freq'); //new row for frequency io
		//ROW CONTROLS

		//create frequency numerical input
		currentrow.numberInput = $("<input type='number' value='440'>");
		currentrow.append(currentrow.numberInput);

		//we use parent() to get to object reference stored in its data and call a method
		//and we have to wrap the call in an anonymous function so we can do some maths...
		currentrow.numberInput.on ('keyup mouseup', function() {
			$( this ).parents( '.node-controls' ).data( 'rootObj' ).updateOsc( 'freq', this.value );
		});

		//END ROW CONTROLS


		currentrow = NodeOp.createRow(this.controls, 'data'); //new row for data

		//simply displays current frequency
		this.controls.freqDisplay = $( "<p>" + this.osc.frequency.value + "hz " + " wave</p>" );
		currentrow.append (this.controls.freqDisplay);
		//console.log ( currentrow);


		//this is TEMPORARY and should be done in app with multiple controls!!
		//this.osc.connect(audioContext.destination);
		//this.osc.start();

		//NOT TEMPORARY
		this.updateOsc('freq', 440);

	}

	OscNode.prototype.updateOsc = function(type, value) {
		console.log (type,value);
		if (type = 'freq') {		
			this.osc.frequency.value = value;
			this.controls.freqDisplay.html( this.osc.frequency.value.toFixed(2) + "hz " + this.osc.type );
		}
	}




	function createNode (nodetype) {
		var node;			//a reference to the node we're creating
		var locateNode;		//the location in nodeArray we want to store that reference

		switch(nodetype) {
			case ('osc'):

				//console.log ('you wanna create an oscillator?');
				node = new OscNode();

				break;

			case ('gain'):

				//console.log ('makin a gain node nao');
				node = new GainNode();

				break;

			default:

				console.log ('ERROR: Node kind not defined!');

		}

		//nodeArray.push (node);
		//console.log(nodeArray);
		//console.log (nodeArray[0].controls.freq.val() );
	}
});
	</script>
</html>
